rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function - check if user is authenticated and owns the document
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.token.email == userId;
    }
    
    // All collections under /users/{userId}
    match /users/{userId} {
      // Allow users to read/write their own user document
      allow read, write: if isOwner(userId);
      
      // Profile data
      match /profile/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // Uploaded files metadata
      match /files/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // Credits and subscription data
      match /credits/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // College list
      match /college_list/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // College fits (fit analyses)
      match /college_fits/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // Profile chat conversations
      match /chat_conversations/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // Fit chat conversations
      match /fit_chat_conversations/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
